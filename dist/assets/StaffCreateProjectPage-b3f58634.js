import{c as E,R as de,j as e,a as ie,L as c,I as f,S as v,b as w,d as S,e as C,f as h,U as ne,g as oe,u as ce,h as me,i as ue,r as a,Z as q,B as U,m as xe,C as he,k as pe,l as ge,F as fe,n as be,o as je,P as z,J as ke,p as Ne}from"./index-39e056cd.js";const B=E("AlertTriangle",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z",key:"c3ski4"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),ye=E("Building",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",ry:"2",key:"76otgf"}],["path",{d:"M9 22v-4h6v4",key:"r93iot"}],["path",{d:"M8 6h.01",key:"1dz90k"}],["path",{d:"M16 6h.01",key:"1x0f13"}],["path",{d:"M12 6h.01",key:"1vi96p"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M8 14h.01",key:"6423bh"}]]),J=E("CalendarDays",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",ry:"2",key:"eu3xkr"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]]),P=de.forwardRef(({className:r,...d},t)=>e.jsx("textarea",{className:ie("flex min-h-[80px] w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm ring-offset-white placeholder:text-slate-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-950 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 dark:border-slate-800 dark:bg-slate-950 dark:ring-offset-slate-950 dark:placeholder:text-slate-400 dark:focus-visible:ring-slate-300",r),ref:t,...d}));P.displayName="Textarea";const ve=[{value:"Residential Solar",label:"Residential Solar PV"},{value:"Commercial Solar",label:"Commercial Solar PV"},{value:"Battery Storage",label:"Battery Storage System"},{value:"EV Charger",label:"EV Charger Installation"},{value:"Other",label:"Other Custom Project"}],we=({projectName:r,setProjectName:d,projectType:t,setProjectType:u,projectAddress:o,setProjectAddress:n,startDate:m,setStartDate:g,deadline:x,setDeadline:i})=>e.jsxs("section",{className:"space-y-4 p-6 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/30 shadow-inner",children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center text-slate-700 dark:text-slate-200",children:[e.jsx(ye,{className:"mr-2 h-6 w-6 text-purple-500 dark:text-purple-400"}),"Project Information"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx(c,{htmlFor:"projectName",className:"text-slate-700 dark:text-slate-300 font-medium",children:"Project Name"}),e.jsx(f,{id:"projectName",value:r,onChange:s=>d(s.target.value),placeholder:"e.g., Smith Residence Solar",required:!0,className:"mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:border-purple-500 dark:focus:border-purple-500"})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"projectType",className:"text-slate-700 dark:text-slate-300 font-medium",children:"Project Type"}),e.jsxs(v,{onValueChange:u,value:t,required:!0,children:[e.jsx(w,{id:"projectType",className:"w-full mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-purple-500 dark:focus:ring-purple-500",children:e.jsx(S,{placeholder:"Select project type"})}),e.jsx(C,{className:"bg-white dark:bg-slate-800",children:ve.map(s=>e.jsx(h,{value:s.value,children:s.label},s.value))})]})]})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"projectAddress",className:"text-slate-700 dark:text-slate-300 font-medium",children:"Project Address"}),e.jsx(P,{id:"projectAddress",value:o,onChange:s=>n(s.target.value),placeholder:"123 Main St, Anytown, USA",required:!0,className:"mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:border-purple-500 dark:focus:border-purple-500"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsxs(c,{htmlFor:"startDate",className:"text-slate-700 dark:text-slate-300 font-medium flex items-center",children:[e.jsx(J,{className:"mr-2 h-4 w-4 text-slate-500 dark:text-slate-400"})," Start Date"]}),e.jsx(f,{id:"startDate",type:"date",value:m,onChange:s=>g(s.target.value),className:"mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:border-purple-500 dark:focus:border-purple-500"})]}),e.jsxs("div",{children:[e.jsxs(c,{htmlFor:"deadline",className:"text-slate-700 dark:text-slate-300 font-medium flex items-center",children:[e.jsx(J,{className:"mr-2 h-4 w-4 text-slate-500 dark:text-slate-400"})," Deadline"]}),e.jsx(f,{id:"deadline",type:"date",value:x,onChange:s=>i(s.target.value),className:"mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:border-purple-500 dark:focus:border-purple-500"})]})]})]}),Se=({clientSelectionMode:r,setClientSelectionMode:d,clientName:t,setClientName:u,clientEmail:o,setClientEmail:n,existingClients:m,existingClientId:g,setExistingClientId:x})=>e.jsxs("section",{className:"space-y-4 p-6 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/30 shadow-inner",children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center text-slate-700 dark:text-slate-200",children:[e.jsx(ne,{className:"mr-2 h-6 w-6 text-purple-500 dark:text-purple-400"}),"Client Information"]}),e.jsxs(v,{onValueChange:d,defaultValue:"new",children:[e.jsx(w,{className:"w-full md:w-1/2 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-purple-500 dark:focus:ring-purple-500",children:e.jsx(S,{placeholder:"Select client type"})}),e.jsxs(C,{className:"bg-white dark:bg-slate-800",children:[e.jsx(h,{value:"new",children:"New Client"}),e.jsx(h,{value:"existing",children:"Existing Client"})]})]}),r==="new"&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mt-4",children:[e.jsxs("div",{children:[e.jsx(c,{htmlFor:"clientName",className:"text-slate-700 dark:text-slate-300 font-medium",children:"Client Full Name"}),e.jsx(f,{id:"clientName",value:t,onChange:i=>u(i.target.value),placeholder:"John Doe",required:r==="new",className:"mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:border-purple-500 dark:focus:border-purple-500"})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"clientEmail",className:"text-slate-700 dark:text-slate-300 font-medium",children:"Client Email"}),e.jsx(f,{id:"clientEmail",type:"email",value:o,onChange:i=>n(i.target.value),placeholder:"client@example.com",required:r==="new",className:"mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:border-purple-500 dark:focus:border-purple-500"})]})]}),r==="existing"&&e.jsxs("div",{className:"mt-4",children:[e.jsx(c,{htmlFor:"existingClient",className:"text-slate-700 dark:text-slate-300 font-medium",children:"Select Existing Client"}),e.jsxs(v,{onValueChange:x,value:g,required:r==="existing",children:[e.jsx(w,{id:"existingClient",className:"w-full mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-purple-500 dark:focus:ring-purple-500",children:e.jsx(S,{placeholder:"Select an existing client"})}),e.jsx(C,{className:"bg-white dark:bg-slate-800",children:m.length>0?m.map(i=>e.jsxs(h,{value:i.id,children:[i.full_name," (",i.email,")"]},i.id)):e.jsx(h,{value:"no_clients",disabled:!0,children:"No existing clients found"})})]})]})]}),Ce=({staffMembers:r,assignedStaffId:d,setAssignedStaffId:t,notes:u,setNotes:o})=>e.jsxs("section",{className:"space-y-4 p-6 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/30 shadow-inner",children:[e.jsxs("h2",{className:"text-xl font-semibold flex items-center text-slate-700 dark:text-slate-200",children:[e.jsx(oe,{className:"mr-2 h-6 w-6 text-purple-500 dark:text-purple-400"}),"Staff Assignment & Notes"]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"assignedStaff",className:"text-slate-700 dark:text-slate-300 font-medium",children:"Assign Staff (Drafter/PM)"}),e.jsxs(v,{onValueChange:t,value:d,children:[e.jsx(w,{id:"assignedStaff",className:"w-full mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-purple-500 dark:focus:ring-purple-500",children:e.jsx(S,{placeholder:"Select staff member"})}),e.jsxs(C,{className:"bg-white dark:bg-slate-800",children:[e.jsx(h,{value:"",children:"None"}),r.map(n=>e.jsx(h,{value:n.id,children:n.full_name},n.id))]})]})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"notes",className:"text-slate-700 dark:text-slate-300 font-medium",children:"Additional Notes"}),e.jsx(P,{id:"notes",value:u,onChange:n=>o(n.target.value),placeholder:"Any specific instructions or details...",className:"mt-1 bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:border-purple-500 dark:focus:border-purple-500"})]})]}),Pe=()=>{const{user:r,role:d}=ce(),{toast:t}=me(),u=ue(),[o,n]=a.useState(""),[m,g]=a.useState(""),[x,i]=a.useState(""),[s,O]=a.useState(""),[b,Z]=a.useState(""),[D,Y]=a.useState("new"),[A,G]=a.useState(""),[F,H]=a.useState(""),[M,$]=a.useState(""),[j,K]=a.useState(""),[I,Q]=a.useState(""),[T,W]=a.useState([]),[X,ee]=a.useState([]),[_,k]=a.useState(!1),[V,R]=a.useState(!0),[N,p]=a.useState(null);a.useEffect(()=>{(async()=>{R(!0),p(null);try{const l=await be(t);W(l.existingClients),ee(l.staffMembers)}catch(l){console.error("Initial data load failed:",l),t({variant:"destructive",title:"Error Loading Data",description:l.message||"Could not load necessary data for the form."}),p("Failed to load initial data. Please try refreshing the page.")}finally{R(!1)}})()},[t]);const te=async L=>{if(L.preventDefault(),!r||d!=="staff_admin"&&d!=="staff_manager"){t({variant:"destructive",title:"Unauthorized",description:"You are not authorized to create projects."});return}if(k(!0),p(null),!o||!m||!x){t({variant:"destructive",title:"Validation Error",description:"Project Name, Type, and Address are required."}),p("Project Name, Type, and Address are required."),k(!1);return}if(s&&b&&new Date(s)>new Date(b)){t({variant:"destructive",title:"Validation Error",description:"Start Date cannot be after Deadline."}),p("Start Date cannot be after Deadline."),k(!1);return}try{const{finalClientId:l,finalClientEmail:y}=await je({clientSelectionMode:D,clientName:F,clientEmail:A,existingClientId:M,existingClients:T,toast:t}),ae=j?z.PENDING:z.DRAFT,se={project_name:o,type:m,client_id:l||null,client_email:y,address:x,start_date:s||null,deadline:b||null,assigned_staff_id:j||null,notes:I,status:ae,current_phase_index:0,phases:ke.map(le=>({...le,assigned_staff:j||""})),created_by:r.id},re=await Ne(se);t({title:"Success!",description:`Project "${re.project_name}" has been created successfully.`}),u("/staff/dashboard")}catch(l){console.error("Error creating project:",l);const y=l.message||"An unexpected error occurred during project creation.";l.message!=="Validation Error"&&l.message!=="Email Check Error"&&l.message!=="Email Conflict Error"&&l.message!=="Client Data Error"&&t({variant:"destructive",title:"Project Creation Failed",description:y}),p(y)}finally{k(!1)}};return V?e.jsxs("div",{className:"flex flex-col items-center justify-center h-[calc(100vh-250px)]",children:[e.jsx(q,{className:"h-16 w-16 text-purple-500 animate-pulse mb-4"}),e.jsx("p",{className:"text-xl text-slate-600 dark:text-slate-300",children:"Loading form data..."})]}):N&&!o&&!m?e.jsxs("div",{className:"flex flex-col items-center justify-center h-[calc(100vh-250px)] text-center p-4",children:[e.jsx(B,{className:"h-16 w-16 text-red-500 mb-4"}),e.jsx("h2",{className:"text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-2",children:"Failed to Load Form Data"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400 mb-4",children:N}),e.jsx(U,{onClick:()=>window.location.reload(),className:"bg-purple-600 hover:bg-purple-700 text-white",children:"Refresh Page"})]}):d!=="staff_admin"&&d!=="staff_manager"?e.jsxs("div",{className:"flex flex-col items-center justify-center h-[calc(100vh-250px)] text-center p-4",children:[e.jsx(q,{className:"h-16 w-16 text-red-500 mb-4"}),e.jsx("h2",{className:"text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-400",children:"You do not have permission to create new projects."})]}):e.jsx(xe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"max-w-3xl mx-auto",children:e.jsx(he,{className:"bg-white dark:bg-slate-800 shadow-2xl",children:e.jsxs(pe,{className:"pt-6",children:[N&&e.jsxs("div",{className:"mb-6 p-4 bg-red-100 dark:bg-red-900/30 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-300 rounded-md flex items-center",children:[e.jsx(B,{className:"h-5 w-5 mr-2"}),e.jsx("span",{children:N})]}),e.jsxs("form",{onSubmit:te,className:"space-y-8",children:[e.jsx(we,{projectName:o,setProjectName:n,projectType:m,setProjectType:g,projectAddress:x,setProjectAddress:i,startDate:s,setStartDate:O,deadline:b,setDeadline:Z}),e.jsx(Se,{clientSelectionMode:D,setClientSelectionMode:Y,clientName:F,setClientName:H,clientEmail:A,setClientEmail:G,existingClients:T,existingClientId:M,setExistingClientId:$}),e.jsx(Ce,{staffMembers:X,assignedStaffId:j,setAssignedStaffId:K,notes:I,setNotes:Q}),e.jsx(ge,{className:"flex justify-end pt-8",children:e.jsx(U,{type:"submit",className:"px-8 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-semibold shadow-lg",disabled:_||V,children:_?"Creating Project...":e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"mr-2 h-5 w-5"})," Create Project"]})})})]})]})})})};export{Pe as default};
